{% extends "base.html" %}

{% block title %}Access Control Management - Port Management System{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">
        <span class="material-symbols-outlined" style="margin-right: 8px;">shield</span>
        Access Control Management
    </h1>
    <p class="page-subtitle">Manage user roles and entity permissions</p>
</div>

<div class="row">
    <!-- Role Permissions Panel -->
    <div class="col-md-7">
        <div class="card-sap">
            <div class="card-header">
                <span class="material-symbols-outlined" style="margin-right: 5px;">admin_panel_settings</span>
                Role Permissions
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select Role:</label>
                    <select id="roleSelect" class="form-control">
                        <option value="">Choose a role...</option>
                        {% for role in roles %}
                        <option value="{{ role.id }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="permissionsTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sap table-sm">
                            <thead>
                                <tr>
                                    <th>Entity Type</th>
                                    <th style="width: 60px; text-align: center;">Read</th>
                                    <th style="width: 60px; text-align: center;">Create</th>
                                    <th style="width: 60px; text-align: center;">Update</th>
                                    <th style="width: 60px; text-align: center;">Delete</th>
                                </tr>
                            </thead>
                            <tbody id="permissionsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Role Assignments Panel -->
    <div class="col-md-5">
        <div class="card-sap">
            <div class="card-header">
                <span class="material-symbols-outlined" style="margin-right: 5px;">people</span>
                User Role Assignments
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select User:</label>
                    <select id="userSelect" class="form-control">
                        <option value="">Choose a user...</option>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.full_name or user.username }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="userRolesSection" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Assign New Role:</label>
                        <div class="input-group">
                            <select id="newRoleSelect" class="form-control">
                                <option value="">Choose a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn-sap btn-primary" onclick="assignRoleToUser()">
                                <span class="material-symbols-outlined" style="font-size: 14px;">add</span>
                                Assign
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">Current Roles:</label>
                        <div id="userRolesList"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card-sap mt-3">
            <div class="card-header">
                <span class="material-symbols-outlined" style="margin-right: 5px;">add_circle</span>
                Quick Actions
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-2">
                        <button class="btn-sap btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            <span class="material-symbols-outlined" style="font-size: 14px;">person_add</span>
                            Create User
                        </button>
                    </div>
                    <div class="col-6 mb-2">
                        <button class="btn-sap btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createRoleModal">
                            <span class="material-symbols-outlined" style="font-size: 14px;">shield</span>
                            Create Role
                        </button>
                    </div>
                </div>
                <hr style="margin: 10px 0;">
                <div class="row text-center" style="font-size: 11px;">
                    <div class="col-6">
                        <div style="font-size: 20px; font-weight: 600; color: var(--sap-blue);">{{ roles|length }}</div>
                        <small class="text-muted">Total Roles</small>
                    </div>
                    <div class="col-6">
                        <div style="font-size: 20px; font-weight: 600; color: #28a745;">{{ users|length }}</div>
                        <small class="text-muted">Active Users</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-symbols-outlined" style="margin-right: 5px;">person_add</span>
                    Create New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="newEmail" name="email" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="newFirstName" name="first_name">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="newLastName" name="last_name">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="newPassword" name="password" required>
                        <small class="form-text text-muted">Minimum 6 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign Roles (Optional)</label>
                        <select class="form-control" id="newUserRoles" multiple size="4">
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple roles</small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="newUserActive" checked>
                        <label class="form-check-label" for="newUserActive">
                            Active User
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sap" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-sap btn-primary">
                        <span class="material-symbols-outlined" style="font-size: 14px;">save</span>
                        Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-symbols-outlined" style="margin-right: 5px;">shield</span>
                    Create New Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createRoleForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Role Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newRoleCode" name="code" required 
                               placeholder="e.g., PORT_OPERATOR" style="text-transform: uppercase;">
                        <small class="form-text text-muted">Unique identifier (uppercase, no spaces)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newRoleName" name="name" required
                               placeholder="e.g., Port Operator">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="newRoleDescription" name="description" rows="3"
                                  placeholder="Brief description of this role's responsibilities"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="newRoleActive" checked>
                        <label class="form-check-label" for="newRoleActive">
                            Active Role
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sap" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-sap btn-primary">
                        <span class="material-symbols-outlined" style="font-size: 14px;">save</span>
                        Create Role
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentRoleId = null;
let currentUserId = null;
let allEntityTypes = {{ entity_types | tojson }};

// Role Permissions Management
document.getElementById('roleSelect').addEventListener('change', async function() {
    currentRoleId = this.value;
    if (!currentRoleId) {
        document.getElementById('permissionsTable').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/access-control/role/${currentRoleId}/permissions`);
        const permissions = await response.json();
        
        const tbody = document.getElementById('permissionsBody');
        tbody.innerHTML = '';
        
        allEntityTypes.forEach(entity => {
            const perm = permissions.find(p => p.entity_type_id === entity.id) || {
                can_read: false,
                can_create: false,
                can_update: false,
                can_delete: false
            };
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>${entity.name}</strong><br><small class="text-muted">${entity.module.name}</small></td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${perm.can_read ? 'checked' : ''} 
                               onchange="updatePermission(${currentRoleId}, ${entity.id}, 'can_read', this.checked)">
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${perm.can_create ? 'checked' : ''} 
                               onchange="updatePermission(${currentRoleId}, ${entity.id}, 'can_create', this.checked)">
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${perm.can_update ? 'checked' : ''} 
                               onchange="updatePermission(${currentRoleId}, ${entity.id}, 'can_update', this.checked)">
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${perm.can_delete ? 'checked' : ''} 
                               onchange="updatePermission(${currentRoleId}, ${entity.id}, 'can_delete', this.checked)">
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('permissionsTable').style.display = 'block';
    } catch (error) {
        console.error('Error loading permissions:', error);
        showToast('Error loading permissions', 'error');
    }
});

async function updatePermission(roleId, entityTypeId, field, value) {
    try {
        const currentPerms = await fetch(`/access-control/role/${roleId}/permissions`).then(r => r.json());
        const existingPerm = currentPerms.find(p => p.entity_type_id === entityTypeId) || {};
        
        const permData = {
            entity_type_id: entityTypeId,
            can_read: existingPerm.can_read || false,
            can_create: existingPerm.can_create || false,
            can_update: existingPerm.can_update || false,
            can_delete: existingPerm.can_delete || false
        };
        
        permData[field] = value;
        
        const response = await fetch(`/access-control/role/${roleId}/permission`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(permData)
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Permission updated successfully', 'success');
        } else {
            showToast(data.error || 'Failed to update permission', 'error');
        }
    } catch (error) {
        console.error('Error updating permission:', error);
        showToast('Error updating permission', 'error');
    }
}

// User Role Management
document.getElementById('userSelect').addEventListener('change', async function() {
    currentUserId = this.value;
    if (!currentUserId) {
        document.getElementById('userRolesSection').style.display = 'none';
        return;
    }
    
    await loadUserRoles(currentUserId);
    document.getElementById('userRolesSection').style.display = 'block';
});

async function loadUserRoles(userId) {
    try {
        const response = await fetch(`/access-control/user/${userId}/roles`);
        const roles = await response.json();
        
        const rolesList = document.getElementById('userRolesList');
        if (roles.length === 0) {
            rolesList.innerHTML = '<p class="text-muted" style="font-size: 11px;">No roles assigned</p>';
            return;
        }
        
        rolesList.innerHTML = roles.map(role => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 4px;">
                <span style="font-size: 12px;"><strong>${role.name}</strong></span>
                <button class="btn-sap" style="padding: 2px 6px; color: #dc3545;" 
                        onclick="removeRoleFromUser(${userId}, ${role.id})">
                    <span class="material-symbols-outlined" style="font-size: 12px;">close</span>
                </button>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading user roles:', error);
        showToast('Error loading user roles', 'error');
    }
}

async function assignRoleToUser() {
    const roleId = document.getElementById('newRoleSelect').value;
    if (!roleId || !currentUserId) {
        showToast('Please select a role', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/access-control/user/${currentUserId}/assign-role`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ role_id: roleId })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Role assigned successfully', 'success');
            document.getElementById('newRoleSelect').value = '';
            await loadUserRoles(currentUserId);
        } else {
            showToast(data.error || 'Failed to assign role', 'error');
        }
    } catch (error) {
        console.error('Error assigning role:', error);
        showToast('Error assigning role', 'error');
    }
}

async function removeRoleFromUser(userId, roleId) {
    if (!confirm('Are you sure you want to remove this role from the user?')) {
        return;
    }
    
    try {
        const response = await fetch(`/access-control/user/${userId}/remove-role/${roleId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Role removed successfully', 'success');
            await loadUserRoles(userId);
        } else {
            showToast(data.error || 'Failed to remove role', 'error');
        }
    } catch (error) {
        console.error('Error removing role:', error);
        showToast('Error removing role', 'error');
    }
}

// Create User Form
document.getElementById('createUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        username: document.getElementById('newUsername').value,
        email: document.getElementById('newEmail').value,
        first_name: document.getElementById('newFirstName').value,
        last_name: document.getElementById('newLastName').value,
        password: document.getElementById('newPassword').value,
        is_active: document.getElementById('newUserActive').checked,
        role_ids: Array.from(document.getElementById('newUserRoles').selectedOptions).map(opt => opt.value)
    };
    
    if (formData.password.length < 6) {
        showToast('Password must be at least 6 characters', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/access-control/users/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('User created successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
            this.reset();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast(data.error || 'Failed to create user', 'error');
        }
    } catch (error) {
        console.error('Error creating user:', error);
        showToast('Error creating user: ' + error.message, 'error');
    }
});

// Create Role Form
document.getElementById('createRoleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        code: document.getElementById('newRoleCode').value.toUpperCase(),
        name: document.getElementById('newRoleName').value,
        description: document.getElementById('newRoleDescription').value,
        is_active: document.getElementById('newRoleActive').checked
    };
    
    try {
        const response = await fetch('/access-control/roles/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Role created successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createRoleModal')).hide();
            this.reset();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast(data.error || 'Failed to create role', 'error');
        }
    } catch (error) {
        console.error('Error creating role:', error);
        showToast('Error creating role: ' + error.message, 'error');
    }
});

// Auto-uppercase role code
document.getElementById('newRoleCode').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/\s+/g, '_');
});
</script>

<style>
.table-sap input[type="checkbox"] {
    cursor: pointer;
    width: 16px;
    height: 16px;
}

.table-sap tbody tr:hover {
    background-color: var(--sap-light-blue);
}

.modal-content {
    border-radius: 8px;
    border: 1px solid var(--sap-border);
}

.modal-header {
    background-color: var(--sap-gray);
    border-bottom: 1px solid var(--sap-border);
    padding: 12px 15px;
}

.modal-title {
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.modal-body {
    padding: 15px;
}

.modal-body .form-label {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 4px;
}

.modal-body .form-control {
    font-size: 11px;
}

.modal-footer {
    padding: 10px 15px;
    border-top: 1px solid var(--sap-border);
}
</style>
{% endblock %}