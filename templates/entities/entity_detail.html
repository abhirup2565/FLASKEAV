{% extends "base.html" %}

{% block title %}{{ entity_type.name }} Detail - Port Management System{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">{{ entity_type.name }} Detail</h1>
    <nav class="content-breadcrumb">
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <span> / </span>
        <a href="{{ url_for('module_view', module_id=entity_type.module_id) }}">{{ entity_type.module.name }}</a>
        <span> / </span>
        <a href="{{ url_for('entity_list', entity_type_id=entity_type.id) }}">{{ entity_type.name }}</a>
        <span> / </span>
        <span>{{ instance_data.instance_code or instance_data.id }}</span>
    </nav>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <div class="toolbar-section">
        <a href="{{ url_for('entity_list', entity_type_id=entity_type.id) }}" class="btn-sap">
            <span class="material-symbols-outlined">arrow_back</span>
            Back to List
        </a>
    </div>
    
    <div class="toolbar-separator"></div>
    
    <div class="toolbar-section">
        <a href="{{ url_for('entity_edit', entity_type_id=entity_type.id, instance_id=instance.id) }}" class="btn-sap btn-primary">
            <span class="material-symbols-outlined">edit</span>
            Edit
        </a>
        <button class="btn-sap" onclick="printRecord()">
            <span class="material-symbols-outlined">print</span>
            Print
        </button>
        <button class="btn-sap" onclick="refreshDetail()">
            <span class="material-symbols-outlined">refresh</span>
            Refresh
        </button>
    </div>
</div>

<!-- Main Detail Card -->
<div class="card-sap">
    <div class="card-header">
        <span class="material-symbols-outlined" style="margin-right: 5px;">{{ entity_type.icon or 'description' }}</span>
        {{ entity_type.name }} - {{ instance_data.instance_code or instance_data.id }}
        {% if instance_data.workflow_status %}
        <span class="badge bg-info" style="margin-left: 10px; font-size: 10px;">{{ instance_data.workflow_status }}</span>
        {% endif %}
    </div>
    <div class="card-body">
        <!-- System Information -->
        <div class="row mb-3">
            <div class="col-md-6">
                <small class="text-muted">Created: {{ instance_data.created_at | format_datetime }}</small>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">Last Updated: {{ instance_data.updated_at | format_datetime }}</small>
            </div>
        </div>
        
        <!-- Attribute Fields -->
        <div class="row">
            {% for field in form_fields %}
            {% if field.is_visible %}
            {% set attr_code = field.attribute_definition.code %}
            {% set attr_data = instance_data.attributes.get(attr_code) %}
            <div class="col-md-{{ 6 if form_fields|length > 6 else 12 }} mb-3">
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">
                        {{ field.field_label or field.attribute_definition.name }}
                    </label>
                    <div style="padding: 6px 0; font-size: 12px;">
                        {% if attr_data and attr_data.value %}
                            {% if field.attribute_definition.data_type.value in ['DATE', 'DATETIME', 'TIMESTAMP'] %}
                                <span class="material-symbols-outlined" style="font-size: 14px; margin-right: 4px; color: var(--sap-blue);">event</span>
                                {{ attr_data.value | format_datetime }}
                            {% elif field.attribute_definition.data_type.value == 'DECIMAL' %}
                                <span class="material-symbols-outlined" style="font-size: 14px; margin-right: 4px; color: var(--sap-blue);">payments</span>
                                {{ attr_data.value | format_currency if 'amount' in attr_code.lower() or 'price' in attr_code.lower() else attr_data.value }}
                            {% elif field.attribute_definition.data_type.value == 'BOOLEAN' %}
                                <span class="material-symbols-outlined" style="font-size: 14px; margin-right: 4px; color: {{ 'green' if attr_data.value else 'red' }};">
                                    {{ 'check_circle' if attr_data.value else 'cancel' }}
                                </span>
                                {{ 'Yes' if attr_data.value else 'No' }}
                            {% else %}
                                <span class="material-symbols-outlined" style="font-size: 14px; margin-right: 4px; color: var(--sap-blue);">text_fields</span>
                                {{ attr_data.value }}
                            {% endif %}
                        {% else %}
                            <span style="color: var(--sap-text-muted); font-style: italic;">Not specified</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
    function refreshDetail() {
        const btn = event.target.closest('button');
        const hideLoading = showLoading(btn);
        
        setTimeout(() => {
            hideLoading();
            window.location.reload();
        }, 1000);
    }
    
    function printRecord() {
        window.print();
    }
    
    function addChildRecord(tabCode) {
        // In a real application, this would open a modal or navigate to a child form
        alert(`Add new record to ${tabCode} - This functionality would be implemented based on your requirements`);
    }
    
    function editChildRecord(tabCode, instanceId) {
        // In a real application, this would open a modal or navigate to edit form
        alert(`Edit ${tabCode} record ${instanceId} - This functionality would be implemented based on your requirements`);
    }
    
    function deleteChildRecord(tabCode, instanceId) {
        if (confirmDelete(`Are you sure you want to delete this ${tabCode} record?`)) {
            // In a real application, this would make an API call to delete the record
            alert(`Delete ${tabCode} record ${instanceId} - This functionality would be implemented based on your requirements`);
        }
    }
    
    // Auto-focus on first tab when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const firstTab = document.querySelector('.nav-tabs-sap .nav-link');
        if (firstTab) {
            firstTab.focus();
        }
    });
</script>

<style>
    @media print {
        .toolbar, .sidebar, .main-header, .nav-tabs-sap {
            display: none !important;
        }
        
        .main-content {
            margin-left: 0 !important;
            margin-top: 0 !important;
        }
        
        .card-sap {
            border: none !important;
            box-shadow: none !important;
        }
    }
</style>
{% endblock %}